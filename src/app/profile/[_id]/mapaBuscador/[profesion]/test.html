<!DOCTYPE html>
<html>
  <head>
    <title>WebSocket Chat</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <div class="container mt-3">
      <h1>FastAPI WebSocket Chat</h1>
      <div id="user-info">
        <label for="user-id">Tu ID:</label>
        <input
          type="text"
          class="form-control"
          id="user-id"
          placeholder="Introduce tu ID"
          autocomplete="off"
        />
        <button class="btn btn-outline-primary mt-2" id="connect-btn">
          Conectar
        </button>
      </div>
      <div id="chat-box" style="display: none">
        <h2>Conectado como: <span id="ws-id"></span></h2>
        <label for="receiver-id">ID del destinatario:</label>
        <input
          type="text"
          class="form-control"
          id="receiver-id"
          placeholder="Introduce el ID del destinatario"
          autocomplete="off"
        />
        <form action="" onsubmit="sendMessage(event)">
          <input
            type="text"
            class="form-control mt-2"
            id="messageText"
            placeholder="Escribe un mensaje"
            autocomplete="off"
          />
          <input
            type="text"
            class="form-control mt-2"
            id="imageText"
            placeholder="URL de la imagen (opcional)"
            autocomplete="off"
          />
          <button class="btn btn-outline-primary mt-2">Enviar</button>
        </form>
        <ul id="messages" class="mt-3 list-group"></ul>
      </div>
    </div>

    <script>
      let ws
      document.getElementById('connect-btn').addEventListener('click', () => {
        const userId = document.getElementById('user-id').value
        if (!userId) {
          alert('Por favor, introduce tu ID')
          return
        }
        document.querySelector('#ws-id').textContent = userId
        ws = new WebSocket('wss://vps-4057595-x.dattaweb.com/chat/ws/${userId}')

        ws.onopen = () => {
          document.getElementById('chat-box').style.display = 'block'
          document.getElementById('user-info').style.display = 'none'
        }

        ws.onmessage = (event) => {
          const messages = document.getElementById('messages')
          const message = document.createElement('li')
          message.classList.add('list-group-item')
          const content = document.createTextNode(event.data)
          message.appendChild(content)
          messages.appendChild(message)
        }

        ws.onclose = () => {
          alert('WebSocket cerrado.')
          document.getElementById('chat-box').style.display = 'none'
          document.getElementById('user-info').style.display = 'block'
        }

        ws.onerror = (error) => {
          console.error('WebSocket error:', error)
        }
      })

      function sendMessage(event) {
        const receiverId = document.getElementById('receiver-id').value
        const input = document.getElementById('messageText')
        const imageInput = document.getElementById('imageText')
        const message = input.value.trim()
        const image = imageInput.value.trim()

        if (!receiverId || (!message && !image)) {
          alert(
            'Por favor, introduce el ID del destinatario y un mensaje o una imagen'
          )
          return
        }

        ws.send(`${receiverId}:${message}:${image}`)
        const messages = document.getElementById('messages')
        const messageElem = document.createElement('li')
        messageElem.classList.add('list-group-item')
        const content = document.createTextNode(
          `TÃº: ${message} (Imagen: ${image})`
        )
        messageElem.appendChild(content)
        messages.appendChild(messageElem)
        input.value = ''
        imageInput.value = ''
        event.preventDefault()
      }
    </script>
  </body>
</html>
